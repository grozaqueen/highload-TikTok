# TikTok
## 1. Тема и целевая аудитория
TikTok - сервис коротких видео
### MVP
* Регистрация и авторизация
* Публикация видео
* Просмотр видео в ленте
* Взаимодействие между пользователями посредством подписок
* Фидбек к видео через лайки, реакции, комментарии
* Рекомендации
* Поиск
### Целевая аудитория
По состоянию на 2024 год:

- **Ежемесячная аудитория (MAU):** 1,69 миллиарда пользователей.
- **DAU:** 600 млн.
- **Среднее время, проводимое пользователями в приложении:** 58 минут в день. 

**Аудитория:**

- **Возрастное распределение:**
  69,4% аудитории TikTok составляют пользователи в возрасте от 18 до 34 лет.

- **Гендерное распределение:** 50,8% пользователей — мужчины, 49,2% — женщины.

- **Географическое распределение:**
По состоянию на 2024 год, TikTok имеет следующую аудиторию по странам:

| №  | Страна             | Количество пользователей |
|:---|:-------------------|:-------------------------|
| 1  | Индонезия          | 157 млн                  |
| 2  | США                | 120 млн                  |
| 3  | Бразилия           | 105 млн                  |
| 4  | Мексика            | 77 млн                   |
| 5  | Россия             | 56 млн                   |
### Ключевые решения
* Бесконечная лента видео
* Реакции на видео
* Добавление видео в закладки
* Односторонние/двусторонние подписки

## 2. Расчет нагрузки

- **Ежемесячная аудитория (MAU):** 1,69 миллиарда пользователей.
- **DAU:** 600 млн.
- **Среднее время, проводимое пользователями в приложении:** 58 минут в день.
- **Средняя длина видео - 15 секунд, средний размер - 5 МБ**
- **34 млн видео ежедневно публикуются пользователями**
- **С ноября 2021 по январь 2022 года в TikTok зарегистрировалось более 58 млн пользователей**
- **В среднем на 10 просмотров видео приходится 1 лайк**

### 1. Продуктовые метрики

| Метрика | Значение |
|---------|----------|
| Месячная аудитория (MAU) | 1,69 млрд пользователей |
| Дневная аудитория (DAU) | 600 млн пользователей |
| Средний размер хранилища пользователя (видео) | 34 млн видео / 600 млн DAU = 0,057 видео на пользователя в день, 1,71 видео в месяц или около 143 видео за 7 лет|
| Средний размер хранилища пользователя (ГБ) | 0,057 видео * 5 МБ = 0,285 МБ в день на пользователя, 8,55 МБ в месяц * 12 * 7 лет = 718,2 МБ = 7,182 ГБ |

Из источников известно - 58 млн пользователей - прирост за 3 месяца - 8,55 МБ * 12 = 102,6 МБ на одного пользователя за год. 58 000 000 * 4 * 102 МБ = 23664 TB - прирост хранилища за год

#### Среднее количество действий пользователя в день 
| Действие | Значение |
|---------|----------|
| Просмотры видео | 58 минут в среднем в сутки * 60 / 15 секунд средняя длина видео = 232 просмотра в сутки |
| Публикация видео | 34 млн видео / 600 млн DAU = 0,057 видео на пользователя в день |
| Поиск | 1% от просмотров = 2 в сутки |
| Лайки | 10% от просмотров = 23 в сутки |
| Комментарии | оценим как 1% от просмотров = 2 в сутки |
| Подписки | оценим как 0,1% от просмотров = 0,2 в сутки |
| Авторизация | 58 млн (прирост за 3 месяца) /3 месяца/30 дней = 650 тысяч в сутки |

### 2. Технические метрики

#### Размер хранения данных

| Тип данных | Средний размер единицы данных | Количество данных | Размер данных |
|------------|-----------------|----------------|----------------|
| Опубликованные видео | 5 МБ 15 сек. видео | 34 млн в день | 4,7 ПБ в месяц |
| Комментарии | около 2 КБ на 1 комментарий | 2 * 30 * 1,69 млрд в месяц | 89 ТБ в месяц |

Пусть комментарий занимает около 2 кб, мы знаем, что около 2 комментариев оставляет пользователь в сутки => около 60 в месяц, а активных пользователей в месяц 1,69 млрд.

### Сетевой трафик

| Тип трафика | Пиковое потребление (Тбит/с) | Суточный объем |
|------------|-----------------|----------------|
| Просмотр видео | 95,03 | 5 МБ - средний размер видео, 232 просмотра за одним пользователем в день, 600 млн - DAU => 600 * 232 = 139,2 млрд просмотров в день => 696 ПБ/день |
| Публикация видео | 0,0369 | 5 МБ - средний размер видео, 34 млн в день публикуют = 162 ТБ/день |
| Лайки, комментарии | 0,00425 | 13,9 млрд в день * 1 КБ + 1,39 млрд в день * 2 КБ = 16.68 ТБ/день |
| Регистрация | 0,00148 | 650 тысяч в день * пусть 10 КБ на вход = 6,5 ТБ/день |
| Поиск | 0.2574 | 1,39 млрд в день * 2 МБ  = 2780 ТБ/день |

### RPS (Запросы в секунду)

| Тип запроса | RPS | пиковое RPS | 
|------------|------------|------------|
| Просмотр видео | 232 * 600 млн DAU /24/60/60 = 1611111 | 2416666 |
| Публикация видео | 0,057 видео в день публикует пользователь * 600 млн DAU /24/60/60 = 396 | 594 |
| Лайки, реакции | 13,9 млрд /24/60/60 = 161111 | 241666 |
| Комментарии | 1,39 млрд /24/60/60 = 16111 | 24166 |
| Поиск | 1,39 млрд /24/60/60 = 16111 | 24166 |
| Регистрация | 650 тысяч /24/60/60 = 8 | 12 |
| Авторизация | 9 | 13 |
| Бесконечная лента | 5 * 600 млн DAU /24/60/60 = 34722| 52083 |
| Суммарно | 1900000 | 2800000 |

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

* tiktok.com – основной домен

### Обоснования расположения ДЦ

TikTok имеет широкую аудиторию по всему миру, и для обеспечения эффективной работы сервиса можно расположить дата-центры охватив все части света, ориентируясь на страны с наибольшим числом пользователей. Для Азии это будет Индонезия с 157,6 миллионами пользователей и Филиппины (56,1 миллиона), для Северной Америки — США (120,5 миллиона) и Мексика (77,5 миллионов), для Южной Америки — Бразилия (105,3 миллиона), для Европы — Россия (56,0 миллиона), а для Африки — Нигерия и Египет. Также стоит учесть пользователей Таиланда (50,8 миллиона) и Бангладеша (41,1 миллиона), Пакистана (62,1 миллиона).

![image](https://github.com/user-attachments/assets/afe84979-ba6b-4f0b-9536-77df13ba7ffb)

| Регион | Города расположения ДЦ | Обоснование | 
|------------|------------|------------|
| Северная Америка | Нью-Йорк, Лос-Анджелес, Сиэтл, Мехико | Нью-Йорк будет обслуживать северо-восток США, Лос-Анжелес - юго-запад США, Сиэтл - и США, и Канаду, Мехико - Мексику |
| Южная Америка | Манаус, Бразилиа, Монтевидео | Манаус обслуживает север Южной Америки, Монтевидео - юг, Бразилиа - центр |
| Европа и Россия | Москва, Париж, Стокгольм, Новосибирск | Москва обслуживает Россию и Восточную часть Европы, Париж - запад Европы, Стокгольм - Скандинавию, Новосибирск для Сибири и Дальнего Востока |
| Азия | Исламабад, Бангкок, Джакарта, Дакка, Манила, Ханой, Токио | Исламабад обслуживает Пакистан и Непал, Бангкок — Таиланд и Малайзию и Камбоджу, Джакарта — Индонезию и Малайзию, Дакка — Бангладеш и соседние регионы Южной Азии, Манила — Филиппины и Малайзию, Ханой - Вьетнам, Токио - Японию |
| Африка | Каир, Абуджа | Каир обслуживает Северную Африку, Абуджа — Южную Африку |

### Расчет распределения запросов из секции "Расчет нагрузки" по типам запросов по датацентрам

Определим распределение запросов по разным регионам, исходя из следующих пропорций (MAU регионов / общее MAU):

* Северная Америка - 23%
* Южная Америка - 15%
* Россия и Европа - 17%
* Азия - 40%
* Африка - 5%

| Регион | Общий RPS | RPS на 1 ДЦ | 
|------------|------------|------------|
| Северная Америка | 475000 | 109250 - 5,75% |
| Южная Америка | 285000 | 95000 - 5% |
| Европа и Россия | 342000 | 85500 - 4,5% |
| Азия | 760000 | 108571 - 5,7% |
| Африка | 95000 | 47500 - 2,5% |

### Схема DNS балансировки
На основе определенного местоположения пользователя (страна, регион, континент) Geo-DNS выбирает наиболее подходящий датацентр или группу датацентров, которые находятся географически ближе всего.

### Схема Anycast балансировки
После того как Geo-DNS определяет ближайший датацентр, BGP Anycast берет на себя задачу сетевой маршрутизации, чтобы направить трафик к наилучшему маршруту через сеть, оптимизируя задержки и снижая нагрузку на другие датацентры (например, путем изменения метрик bgp используя Least Response Time алгоритм). 

## 4. Локальная балансировка нагрузки

### Cхемы балансировки для входящих и межсервисных запросов
* Virtual Server via Direct Routing (DR). Запрос отправляется на виртуальный IP-адрес (VIP) балансировщика. Балансировщик выбирает один из Nginx-серверов и заменяет MAC-адрес получателя в Ethernet-кадре на MAC-адрес выбранного Nginx-сервера.
* Nginx-сервер обрабатывает запрос и отправляет ответ напрямую клиенту, минуя балансировщик.
* Балансировка на уровне Nginx: Nginx как HTTP Reverse Proxy. Nginx принимает запросы от балансировщика. Балансирует нагрузку между бэкендами с помощью алгоритма Least Connections.

### Cхема отказоустойчивости
Service Discovery Kubernetes постоянно мониторит состояние подов с помощью проб, тем самым автоматизирует процесс регистрации, обновления реестра. В зависимости от прохождения проб, Kubernetes может перезапустить, создать новые контейнеры. Kubernetes автоматически масштабирует количество подов в зависимости от нагрузки.

### Нагрузка по терминации SSL
Используем session tickets для уменьшения количества полных обменов ключами, что снижает нагрузку на CPU. В среднем 4,7% запросов направляется на один дц, при этом в регионе работает 4 дц в среднем. При пиковом трафике 2,8 млн RPS на 1 дц приходится 131k RPS. С учетом Session Tickets, 60% запросов обходят полноценное SSL-рукопожатие, а 40% (53000 RPS) требуют 2 round-trip'а. При средней задержке 2 мс: 2 мс × 53000 = 105 секунд процессорного времени в секунду на один дц. 

## 5. Логическая схема БД
![image](https://github.com/user-attachments/assets/be5286aa-8d51-44d9-b922-3af1fcc83efd)

## Источники
1. https://www.demandsage.com/tiktok-user-statistics
2. https://fliki.ai/blog/tiktok-video-size
3. https://techjury.net/blog/how-many-videos-are-uploaded-to-tiktok-daily/
4. https://ecommerce-platforms.com/ru/articles/tiktok-statistics
5. https://inclient.ru/tiktok-stats
6. https://domainator.by/schitaet-li-tiktok-vashi-sobstvennye-prosmotry
